<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë°ì´í„° ìƒì„±ê¸°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        .table-responsive { max-height: 300px; }
        #log-container { display: none; max-height: 400px; overflow-y: auto; font-family: monospace; background-color:#212529; color: #f8f9fa; }
        #generator-controls, #model-info-area, #graph-area, #analysis-result-area, #llm-analysis-area { display: none; }
        #token-estimation-area, #token-usage-area { display: none; }

        #model-info-area .table th,
        #model-info-area .table td,
        #sample-area .table th,
        #sample-area .table td {
            vertical-align: middle;
        }
        #model-info-area .table th,
        #sample-area .table th {
            background-color: #f8f9fa; 
        }
        .mermaid { text-align: center; margin-bottom: 1rem; }
        #analysis-result-area .badge { font-size: 1em; padding: 0.5em 0.7em; vertical-align: middle; }
        #analysis-result-area .bi-arrow-right { vertical-align: middle; margin: 0 0.5rem; }
        
        #generation-options-modal .form-label { font-weight: 500; }
        .token-card { flex: 1; }
        #llm-analysis-area .card-body h3 { font-size: 1.25rem; margin-top: 1rem; }
        
        /* ê°œì„ : ë¡œë”© ìƒíƒœ ìŠ¤íƒ€ì¼ */
        .loading-overlay {
            position: relative;
            opacity: 0.7;
            pointer-events: none;
        }
        
        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }
        
        .timeout-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .analysis-timeout {
            background-color: #f8d7da;
            border: 1px solid #f5c2c7;
            color: #842029;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">ë°ì´í„° ìƒì„±ê¸°</h1>
            <a href="/" class="btn btn-sm btn-outline-secondary">ì‹œì‘ í˜ì´ì§€ë¡œ</a>
        </div>
        
        <div class="mb-4">
            <label for="model-select" class="form-label"><strong>1. ìƒì„±í•  ë°ì´í„° ëª¨ë¸ ì„ íƒ</strong></label>
            <div class="input-group">
                <select class="form-select" id="model-select">
                    <option selected disabled>ì €ì¥ëœ ëª¨ë¸ì„ ì„ íƒí•˜ì„¸ìš”...</option>
                    {% for filename in model_files %}
                    <option value="{{ filename }}">{{ filename }}</option>
                    {% endfor %}
                </select>
                <button class="btn btn-outline-secondary" type="button" id="analyze-btn" disabled>
                    <i class="bi bi-graph-up"></i> ëª¨ë¸ ìƒì„¸ì •ë³´ ë° ë¶„ì„
                </button>
            </div>
        </div>

        <div id="llm-analysis-area" class="mb-4"></div>
        <div id="analysis-result-area" class="mb-4"></div>
        <div id="graph-area" class="mb-4"></div>
        <div id="model-info-area" class="mb-4"></div>

        <div id="generator-controls">
            <div class="card mb-4">
                <div class="card-header">
                    <strong>2. ë°ì´í„° ìƒì„± ìˆ˜ëŸ‰ ì…ë ¥</strong>
                </div>
                <div class="card-body">
                    <div class="row g-3" id="quantity-form"></div>
                </div>
            </div>
            
            <div id="token-estimation-area" class="alert alert-info my-3" role="alert"></div>
            
            <div id="token-usage-area" class="d-flex gap-3 my-3">
                <div class="card token-card">
                    <div class="card-body text-center">
                        <h6 class="card-title mb-1 text-muted">ì…ë ¥(Prompt) í† í°</h6>
                        <p class="card-text display-6 fw-bold text-primary" id="live-prompt-token-count">0</p>
                    </div>
                </div>
                <div class="card token-card">
                    <div class="card-body text-center">
                        <h6 class="card-title mb-1 text-muted">ì¶œë ¥(Response) í† í°</h6>
                        <p class="card-text display-6 fw-bold text-info" id="live-candidates-token-count">0</p>
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-4">
                <button class="btn btn-info" id="sample-btn">ìƒ˜í”Œ ë³´ê¸°</button>
                <button class="btn btn-primary" id="estimate-btn">ì˜ˆìƒ í† í° ê³„ì‚°</button>
                <button class="btn btn-success" id="generate-btn" disabled>ì „ì²´ ë°ì´í„° ìƒì„±</button>
            </div>

            <div id="sample-area"></div>
        </div>
        
        <div class="form-control mt-3" id="log-container"></div>
    </div>

    <div class="modal fade" id="generation-options-modal" tabindex="-1" aria-labelledby="optionsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="optionsModalLabel">ì»¬ëŸ¼ ìƒì„± ì˜µì…˜ ì„¤ì •</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>í…Œì´ë¸”:</strong> <span id="modal-table-name"></span><br>
                       <strong>ì»¬ëŸ¼:</strong> <span id="modal-column-name"></span></p>
                    <hr>
                    <div id="modal-options-form"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                    <button type="button" class="btn btn-primary" id="save-options-btn">ì„¤ì • ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: false });

        // DOM Element References
        const modelSelect = document.getElementById('model-select');
        const analyzeBtn = document.getElementById('analyze-btn');
        const analysisResultArea = document.getElementById('analysis-result-area');
        const llmAnalysisArea = document.getElementById('llm-analysis-area');
        const graphArea = document.getElementById('graph-area');
        const modelInfoArea = document.getElementById('model-info-area');
        const controls = document.getElementById('generator-controls');
        const quantityForm = document.getElementById('quantity-form');
        const sampleArea = document.getElementById('sample-area');
        const sampleBtn = document.getElementById('sample-btn');
        const estimateBtn = document.getElementById('estimate-btn');
        const generateBtn = document.getElementById('generate-btn');
        const tokenEstimationArea = document.getElementById('token-estimation-area');
        const tokenUsageArea = document.getElementById('token-usage-area');
        const livePromptTokenCount = document.getElementById('live-prompt-token-count');
        const liveCandidatesTokenCount = document.getElementById('live-candidates-token-count');
        const optionsModal = new bootstrap.Modal(document.getElementById('generation-options-modal'));
        const modalForm = document.getElementById('modal-options-form');
        const logContainer = document.getElementById('log-container');

        // Global State
        let currentModel = {};
        let generationOptions = {};
        let analysisTimeout = null;

        // --- Function Definitions ---

        function generateSampleValue(column) {
            const colName = (column.column_name || '').toLowerCase();
            const dataType = (column.data_type || '').toLowerCase();
            if (colName.includes('id')) return '1';
            if (colName.includes('name') || colName.includes('ì´ë¦„')) return 'í™ê¸¸ë™';
            if (colName.includes('email') || colName.includes('ì´ë©”ì¼')) return 'sample@example.com';
            if (colName.includes('date') || colName.includes('created_at') || dataType.includes('timestamp')) return new Date().toISOString().split('T')[0];
            if (colName.includes('price') || colName.includes('amount') || dataType.includes('decimal')) return '10000.00';
            if (colName.includes('quantity') || dataType.includes('int')) return '1';
            if (colName.includes('category')) return 'ìƒ˜í”Œ ì¹´í…Œê³ ë¦¬';
            if (colName.includes('status')) return 'completed';
            if (colName.includes('description') || colName.includes('comment')) return 'ì´ê²ƒì€ ìƒ˜í”Œ ì„¤ëª… í…ìŠ¤íŠ¸ì…ë‹ˆë‹¤.';
            return 'ìƒ˜í”Œ í…ìŠ¤íŠ¸';
        }

        async function generateAndRenderGraph(model) {
            graphArea.innerHTML = '';
            if (!model.tables || !Array.isArray(model.tables)) {
                graphArea.style.display = 'none'; return;
            }
            const tableNames = model.tables.map(t => t.table_name);
            let graphDefinition = 'graph TD;\n';
            tableNames.forEach(name => { graphDefinition += `    ${name}[${name}];\n`; });
            model.tables.forEach(table => {
                const sourceTable = table.table_name;
                if (table.columns && Array.isArray(table.columns)) {
                    table.columns.forEach(column => {
                        const colName = column.column_name;
                        if (colName.endsWith('_id') && colName !== `${sourceTable}_id` && colName !== `${sourceTable.slice(0, -1)}_id`) {
                            const targetTablePrefix = colName.replace('_id', '');
                            const targetTable = tableNames.find(name => name === targetTablePrefix || name === `${targetTablePrefix}s`);
                            if (targetTable && sourceTable !== targetTable) {
                                graphDefinition += `    ${sourceTable} -- "${colName}" --> ${targetTable};\n`;
                            }
                        }
                    });
                }
            });
            const graphCard = document.createElement('div');
            graphCard.className = 'card';
            graphCard.innerHTML = `<div class="card-header"><strong>í…Œì´ë¸” ê´€ê³„ë„</strong></div><div class="card-body"><div class="mermaid">${graphDefinition}</div></div>`;
            graphArea.appendChild(graphCard);
            graphArea.style.display = 'block';
            await mermaid.run({ nodes: graphArea.querySelectorAll('.mermaid') });
        }
        
        function renderModelStructure(model) {
            modelInfoArea.innerHTML = '';
            if (!model.tables || !Array.isArray(model.tables)) {
                modelInfoArea.style.display = 'none';
                return;
            }
            const modelCard = document.createElement('div');
            modelCard.className = 'card';
            modelCard.innerHTML = `<div class="card-header"><strong>ì„ íƒëœ ëª¨ë¸ êµ¬ì¡° ë° ìƒì„± ì˜µì…˜</strong></div>`;
            const modelCardBody = document.createElement('div');
            modelCardBody.className = 'card-body';
            model.tables.forEach(tableDetails => {
                const tableName = tableDetails.table_name;
                if (!tableName) return;
                
                const tableTitle = document.createElement('h6');
                tableTitle.className = 'mt-3 mb-2';
                tableTitle.textContent = `í…Œì´ë¸”: ${tableName}`;
                modelCardBody.appendChild(tableTitle);

                const tableEl = document.createElement('table');
                tableEl.className = 'table table-bordered table-sm';
                tableEl.innerHTML = `<thead class="table-light"><tr><th>ì»¬ëŸ¼ëª…</th><th>íƒ€ì…</th><th>ì„¤ëª…</th><th>ìƒ˜í”Œ</th><th>ì˜µì…˜</th></tr></thead><tbody></tbody>`;
                const tbody = tableEl.querySelector('tbody');
                
                tableDetails.columns.forEach(column => {
                    const colName = column.column_name;
                    const sampleValue = generateSampleValue(column);
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${colName || ''}</td>
                        <td>${column.data_type || ''}</td>
                        <td>${column.description || ''}</td>
                        <td><em>${sampleValue}</em></td>
                        <td><button class="btn btn-sm btn-outline-primary options-btn" data-table-name="${tableName}" data-column-name="${colName}">ì„¤ì •</button></td>`;
                });
                modelCardBody.appendChild(tableEl);
            });
            modelCard.appendChild(modelCardBody);
            modelInfoArea.appendChild(modelCard);
            modelInfoArea.style.display = 'block';
        }

        function openOptionsModal(tableName, columnName) {
            const table = currentModel.tables.find(t => t.table_name === tableName);
            const column = table.columns.find(c => c.column_name === columnName);
            const dataType = (column.data_type || '').toLowerCase();
            const currentOptions = generationOptions[tableName]?.[columnName] || {};

            document.getElementById('modal-table-name').textContent = tableName;
            document.getElementById('modal-column-name').textContent = columnName;
            document.getElementById('save-options-btn').dataset.tableName = tableName;
            document.getElementById('save-options-btn').dataset.columnName = columnName;

            let formHtml = '';
            if (dataType.includes('int') || dataType.includes('decimal')) {
                formHtml = `
                    <div class="mb-3">
                        <label for="option-min" class="form-label">ìµœì†Ÿê°’</label>
                        <input type="number" class="form-control" id="option-min" value="${currentOptions.min || ''}">
                    </div>
                    <div class="mb-3">
                        <label for="option-max" class="form-label">ìµœëŒ“ê°’</label>
                        <input type="number" class="form-control" id="option-max" value="${currentOptions.max || ''}">
                    </div>`;
            } else if (dataType.includes('varchar') || dataType.includes('text')) {
                formHtml = `
                    <div class="mb-3">
                        <label for="option-type" class="form-label">íŠ¹ì • í˜•ì‹</label>
                        <select class="form-select" id="option-type">
                            <option value="">ìë™(ì¶”ë¡ )</option>
                            <option value="name" ${currentOptions.type === 'name' ? 'selected' : ''}>ì´ë¦„</option>
                            <option value="email" ${currentOptions.type === 'email' ? 'selected' : ''}>ì´ë©”ì¼</option>
                            <option value="address" ${currentOptions.type === 'address' ? 'selected' : ''}>ì£¼ì†Œ</option>
                            <option value="company" ${currentOptions.type === 'company' ? 'selected' : ''}>íšŒì‚¬ëª…</option>
                            <option value="phone" ${currentOptions.type === 'phone' ? 'selected' : ''}>ì „í™”ë²ˆí˜¸</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="option-list" class="form-label">ì„ íƒ ëª©ë¡ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                        <textarea class="form-control" id="option-list" rows="3" placeholder="ì˜ˆ: ì™„ë£Œ,ë°°ì†¡ì¤‘,ì·¨ì†Œ">${(currentOptions.list || []).join(',')}</textarea>
                        <div class="form-text">ëª©ë¡ì„ ì…ë ¥í•˜ë©´ ìœ„ íŠ¹ì • í˜•ì‹ë³´ë‹¤ ìš°ì„  ì ìš©ë©ë‹ˆë‹¤.</div>
                    </div>`;
            } else if (dataType.includes('date') || dataType.includes('timestamp')) {
                 formHtml = `
                    <div class="mb-3">
                        <label for="option-start-date" class="form-label">ì‹œì‘ì¼</label>
                        <input type="date" class="form-control" id="option-start-date" value="${currentOptions.startDate || ''}">
                    </div>
                    <div class="mb-3">
                        <label for="option-end-date" class="form-label">ì¢…ë£Œì¼</label>
                        <input type="date" class="form-control" id="option-end-date" value="${currentOptions.endDate || ''}">
                    </div>`;
            } else {
                formHtml = '<p>ì´ ë°ì´í„° íƒ€ì…ì— ëŒ€í•œ ì‚¬ìš©ì ì •ì˜ ì˜µì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
            modalForm.innerHTML = formHtml;
            optionsModal.show();
        }

        // --- Event Listeners ---

        modelSelect.addEventListener('change', async (event) => {
            const filename = event.target.value;
            if (!filename) return;

            // Reset UI
            analyzeBtn.disabled = true;
            generationOptions = {};
            [analysisResultArea, llmAnalysisArea, graphArea, modelInfoArea, tokenEstimationArea].forEach(el => {
                el.style.display = 'none';
                el.innerHTML = '';
            });
            tokenUsageArea.style.display = 'none';
            livePromptTokenCount.textContent = '0';
            liveCandidatesTokenCount.textContent = '0';
            quantityForm.innerHTML = '';
            sampleArea.innerHTML = '';
            
            estimateBtn.disabled = false;
            generateBtn.disabled = true;
            generateBtn.textContent = 'ì „ì²´ ë°ì´í„° ìƒì„±';

            try {
                const response = await fetch(`/get-model/${filename}`);
                if (!response.ok) throw new Error('ëª¨ë¸ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                
                currentModel = await response.json();
                
                if (currentModel.tables && Array.isArray(currentModel.tables)) {
                    currentModel.tables.forEach(tableDetails => {
                        const tableName = tableDetails.table_name;
                        if (!tableName) return;
                        
                        const qtyCol = document.createElement('div');
                        qtyCol.className = 'col-md-4';
                        qtyCol.innerHTML = `<label for="qty-${tableName}" class="form-label">${tableName}</label><input type="number" class="form-control" id="qty-${tableName}" value="100" data-table-name="${tableName}">`;
                        quantityForm.appendChild(qtyCol);
                    });
                } else {
                    quantityForm.innerHTML = '<p class="text-muted">ì„ íƒëœ ëª¨ë¸ì— í…Œì´ë¸” ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
                
                analyzeBtn.disabled = false;
            } catch (error) {
                console.error('ëª¨ë¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                analysisResultArea.innerHTML = `<div class="alert alert-danger">ëª¨ë¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
                analysisResultArea.style.display = 'block';
            }
            
            controls.style.display = 'block';
        });
        
        analyzeBtn.addEventListener('click', async () => {
            const selectedModel = modelSelect.value;
            if (!selectedModel) {
                alert('ëª¨ë¸ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.'); 
                return;
            }
            
            // Reset previous analysis results
            [analysisResultArea, llmAnalysisArea, graphArea, modelInfoArea].forEach(el => {
                el.style.display = 'none';
                el.innerHTML = '';
            });

            // Show loading indicators
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = `
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                ë¶„ì„ ì¤‘...
            `;

            const loadingHtml = `
                <div class="card">
                    <div class="card-header">
                        <strong><i class="bi bi-robot"></i> AI ëª¨ë¸ ë¶„ì„ ë° ìƒì„± ì „ëµ</strong>
                    </div>
                    <div class="card-body text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">ë¶„ì„ ì¤‘...</span>
                        </div>
                        <p class="mt-3 mb-1">AIê°€ ëª¨ë¸ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                        <small class="text-muted">ìµœëŒ€ 35ì´ˆ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
                        <div class="timeout-warning mt-3" style="display: none;">
                            <i class="bi bi-clock"></i> 
                            <strong>ë¶„ì„ì´ ì˜¤ë˜ ê±¸ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.</strong><br>
                            ë³µì¡í•œ ëª¨ë¸ì¼ìˆ˜ë¡ ì‹œê°„ì´ ë” ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </div>
                    </div>
                </div>
            `;
            llmAnalysisArea.innerHTML = loadingHtml;
            llmAnalysisArea.style.display = 'block';

            // Show timeout warning after 15 seconds
            const timeoutWarning = setTimeout(() => {
                const warningEl = llmAnalysisArea.querySelector('.timeout-warning');
                if (warningEl) {
                    warningEl.style.display = 'block';
                }
            }, 15000);

            // Render basic model structure immediately for fast feedback
            renderModelStructure(currentModel);

            try {
                // API call with timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 35000); // 35s timeout

                const response = await fetch(`/analyze-dependencies/${selectedModel}`, {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                clearTimeout(timeoutWarning);

                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }

                // Render LLM analysis result
                if (result.llm_analysis) {
                    const llmCard = document.createElement('div');
                    llmCard.className = 'card';
                    llmCard.innerHTML = `
                        <div class="card-header">
                            <strong><i class="bi bi-robot"></i> AI ëª¨ë¸ ë¶„ì„ ë° ìƒì„± ì „ëµ</strong>
                        </div>
                        <div class="card-body">
                            ${marked.parse(result.llm_analysis)}
                        </div>
                    `;
                    llmAnalysisArea.innerHTML = '';
                    llmAnalysisArea.appendChild(llmCard);
                } else {
                    llmAnalysisArea.innerHTML = `
                        <div class="card">
                            <div class="card-header">
                                <strong><i class="bi bi-info-circle"></i> AI ë¶„ì„</strong>
                            </div>
                            <div class="card-body">
                                <p class="text-muted">AI ë¶„ì„ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ì§€ë§Œ, ê·œì¹™ ê¸°ë°˜ ë¶„ì„ì€ ì •ìƒì ìœ¼ë¡œ ìˆ˜í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    `;
                }

                // Render rule-based analysis result
                let resultHtml = `
                    <div class="card">
                        <div class="card-header">
                            <strong><i class="bi bi-diagram-3"></i> ê·œì¹™ ê¸°ë°˜ ì˜ì¡´ì„± ë¶„ì„</strong>
                        </div>
                        <div class="card-body">
                `;
                
                if (result.generation_order) {
                    const orderHtml = result.generation_order
                        .map(name => `<span class="badge bg-primary">${name}</span>`)
                        .join(' <i class="bi bi-arrow-right"></i> ');
                    resultHtml += `
                        <h6><i class="bi bi-list-ol"></i> ë°ì´í„° ìƒì„± ìˆœì„œ</h6>
                        <p>${orderHtml}</p>
                        <hr>
                    `;
                }
                
                if (result.dependencies && Object.keys(result.dependencies).length > 0) {
                    resultHtml += '<h6><i class="bi bi-arrow-down-up"></i> í…Œì´ë¸”ë³„ ì˜ì¡´ì„±</h6><ul>';
                    for (const table in result.dependencies) {
                        resultHtml += `<li><strong>${table}</strong> â†’ [${result.dependencies[table].join(', ')}]</li>`;
                    }
                    resultHtml += '</ul>';
                } else {
                    resultHtml += '<p><i class="bi bi-check-circle text-success"></i> í…Œì´ë¸” ê°„ ì§ì ‘ì ì¸ ì˜ì¡´ì„±ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>';
                }
                
                resultHtml += '</div></div>';
                analysisResultArea.innerHTML = resultHtml;
                analysisResultArea.style.display = 'block';

                // Render relationship graph
                await generateAndRenderGraph(currentModel);

            } catch (error) {
                clearTimeout(timeoutWarning);
                
                let errorMessage = error.message;
                let errorClass = 'alert-danger';
                
                if (error.name === 'AbortError') {
                    errorMessage = 'ë¶„ì„ ì‹œê°„ì´ 35ì´ˆë¥¼ ì´ˆê³¼í•˜ì—¬ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ëª¨ë¸ì´ ë„ˆë¬´ ë³µì¡í•˜ê±°ë‚˜ ì„œë²„ ì‘ë‹µì´ ëŠë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                    errorClass = 'analysis-timeout alert';
                } else if (errorMessage.includes('timeout')) {
                    errorMessage = 'ì„œë²„ ì‘ë‹µ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.';
                    errorClass = 'analysis-timeout alert';
                }

                llmAnalysisArea.innerHTML = `
                    <div class="${errorClass}" role="alert">
                        <h6><i class="bi bi-exclamation-triangle"></i> ë¶„ì„ ì‹¤íŒ¨</h6>
                        <p class="mb-0">${errorMessage}</p>
                        ${errorClass.includes('timeout') ? 
                            '<small class="d-block mt-2">ğŸ’¡ <strong>íŒ:</strong> í…Œì´ë¸” ìˆ˜ë¥¼ ì¤„ì´ê±°ë‚˜ ë” ê°„ë‹¨í•œ ëª¨ë¸ë¡œ ì‹œë„í•´ë³´ì„¸ìš”.</small>' : 
                            ''
                        }
                    </div>
                `;
                
                // Show basic analysis even on failure
                renderModelStructure(currentModel);
                await generateAndRenderGraph(currentModel);
                
            } finally {
                // Restore button state
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = `<i class="bi bi-graph-up"></i> ëª¨ë¸ ìƒì„¸ì •ë³´ ë° ë¶„ì„`;
            }
        });
        
        estimateBtn.addEventListener('click', async () => {
            const selectedModel = modelSelect.value;
            if (!selectedModel) { alert('ëª¨ë¸ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }

            estimateBtn.disabled = true;
            estimateBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ê³„ì‚° ì¤‘...`;
            tokenEstimationArea.style.display = 'block';
            tokenEstimationArea.className = 'alert alert-info my-3';
            tokenEstimationArea.textContent = 'ì˜ˆìƒ í† í° ì‚¬ìš©ëŸ‰ì„ ê³„ì‚° ì¤‘ì…ë‹ˆë‹¤...';
            generateBtn.disabled = true;

            const quantities = {};
            quantityForm.querySelectorAll('input[type="number"]').forEach(input => {
                quantities[input.dataset.tableName] = input.value;
            });

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 20000); // 20s timeout

                const response = await fetch('/estimate-tokens', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: selectedModel, quantities: quantities }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'ê³„ì‚°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                
                const promptTokens = result.estimated_prompt_tokens ?? 0;
                const candidatesTokens = result.estimated_candidates_tokens ?? 0;

                tokenEstimationArea.innerHTML = `
                    <i class="bi bi-cpu"></i> <strong>ì˜ˆìƒ í† í° ì‚¬ìš©ëŸ‰</strong>
                    <ul class="mb-0">
                        <li>ì…ë ¥(Prompt): ~${promptTokens.toLocaleString()} tokens</li>
                        <li>ì¶œë ¥(Response): ~${candidatesTokens.toLocaleString()} tokens</li>
                    </ul>
                    <p class="mb-0 small mt-2">ì¼ê´„ ìš”ì²­ ë°©ì‹ìœ¼ë¡œ ê³„ì‚°ë˜ì–´ ì‹¤ì œ ì‚¬ìš©ëŸ‰ê³¼ ìœ ì‚¬í•©ë‹ˆë‹¤.</p>
                `;
                generateBtn.disabled = false;

            } catch (error) {
                let errorMessage = error.message;
                if (error.name === 'AbortError') {
                    errorMessage = 'í† í° ê³„ì‚° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.';
                }
                tokenEstimationArea.className = 'alert alert-danger my-3';
                tokenEstimationArea.textContent = `ì˜¤ë¥˜: ${errorMessage}`;
            } finally {
                estimateBtn.disabled = false;
                estimateBtn.innerHTML = 'ì˜ˆìƒ í† í° ê³„ì‚°';
            }
        });

        generateBtn.addEventListener('click', () => {
            const selectedModel = modelSelect.value;
            if (!selectedModel) { alert('ëª¨ë¸ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
            
            generateBtn.disabled = true;
            estimateBtn.disabled = true;
            
            tokenUsageArea.style.display = 'flex';
            livePromptTokenCount.textContent = '0';
            liveCandidatesTokenCount.textContent = '0';
            
            logContainer.style.display = 'block';
            logContainer.innerHTML = 'âœ… ë°ì´í„° ìƒì„± ìŠ¤íŠ¸ë¦¼ ì‹œì‘...\n';
            
            const quantities = {};
            quantityForm.querySelectorAll('input[type="number"]').forEach(input => {
                quantities[input.dataset.tableName] = input.value;
            });
            
            const params = new URLSearchParams(quantities);
            params.append('filename', selectedModel);
            params.append('options', JSON.stringify(generationOptions));
            
            const eventSource = new EventSource(`/start-generation?${params.toString()}`);
            
            const connectionTimeout = setTimeout(() => {
                if (eventSource.readyState === EventSource.CONNECTING) {
                    eventSource.close();
                    logContainer.innerHTML += '<p class="text-danger">ì„œë²„ ì—°ê²° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>';
                    generateBtn.disabled = false;
                    estimateBtn.disabled = false;
                }
            }, 15000); // 15s connection timeout
            
            eventSource.onopen = function() {
                clearTimeout(connectionTimeout);
            };
            
            eventSource.onmessage = function (event) {
                const data = JSON.parse(event.data);
                
                switch (data.type) {
                    case 'log': {
                        const formattedMessage = data.message
                            .replace(/</g, "&lt;").replace(/>/g, "&gt;")
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                        logContainer.innerHTML += `${formattedMessage}\n`;
                        break;
                    }
                    case 'token_update': {
                        livePromptTokenCount.textContent = (data.prompt_tokens ?? 0).toLocaleString();
                        liveCandidatesTokenCount.textContent = (data.candidates_tokens ?? 0).toLocaleString();
                        break;
                    }
                    case 'complete': {
                        clearTimeout(connectionTimeout);
                        const finalPromptTokens = data.prompt_tokens ?? 0;
                        const finalCandidatesTokens = data.candidates_tokens ?? 0;

                        livePromptTokenCount.textContent = finalPromptTokens.toLocaleString();
                        liveCandidatesTokenCount.textContent = finalCandidatesTokens.toLocaleString();
                        
                        const completeMessage = data.message
                            .replace(/</g, "&lt;").replace(/>/g, "&gt;")
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                        
                        logContainer.innerHTML += `<div class="alert alert-success mt-2 p-2">
                            ${completeMessage}<br>
                            <strong>ìµœì¢… ì‚¬ìš© í† í°:</strong> ì…ë ¥ ${finalPromptTokens.toLocaleString()}, ì¶œë ¥ ${finalCandidatesTokens.toLocaleString()}
                        </div>`;
                        
                        eventSource.close();
                        generateBtn.textContent = 'ìƒì„± ì™„ë£Œ!';
                        estimateBtn.disabled = false;
                        break;
                    }
                    case 'error': {
                        clearTimeout(connectionTimeout);
                        logContainer.innerHTML += `<div class="alert alert-danger mt-2 p-2">
                            <strong>ì˜¤ë¥˜:</strong> ${data.message}
                        </div>`;
                        eventSource.close();
                        generateBtn.disabled = false;
                        estimateBtn.disabled = false;
                        break;
                    }
                }
                logContainer.scrollTop = logContainer.scrollHeight;
            };

            eventSource.onerror = function(event) {
                clearTimeout(connectionTimeout);
                logContainer.innerHTML += '<p class="text-danger">ìŠ¤íŠ¸ë¦¼ ì—°ê²°ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>';
                eventSource.close();
                generateBtn.disabled = false;
                estimateBtn.disabled = false;
            };
        });

        sampleBtn.addEventListener('click', async () => {
            const selectedModel = modelSelect.value;
            if (!selectedModel) { alert('ëª¨ë¸ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
            sampleBtn.disabled = true;
            sampleBtn.textContent = 'ìƒ˜í”Œ ìƒì„± ì¤‘...';
            
            sampleArea.innerHTML = '';

            const quantities = {};
            quantityForm.querySelectorAll('input[type="number"]').forEach(input => {
                quantities[input.dataset.tableName] = input.value;
            });

            try {
                const response = await fetch('/generate-sample', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        filename: selectedModel, 
                        quantities: quantities,
                        options: generationOptions
                    })
                });
                
                if (!response.ok) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.error || 'ìƒ˜í”Œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                const sampleDataByTable = await response.json();

                for (const tableName in sampleDataByTable) {
                    const records = sampleDataByTable[tableName];
                    if (!records || records.length === 0) continue;

                    const card = document.createElement('div');
                    card.className = 'card mb-3';
                    card.innerHTML = `<div class="card-header">${tableName} ìƒ˜í”Œ ë°ì´í„°</div>`;
                    
                    const cardBody = document.createElement('div');
                    cardBody.className = 'card-body';

                    const tableResponsive = document.createElement('div');
                    tableResponsive.className = 'table-responsive';
                    
                    const tableEl = document.createElement('table');
                    tableEl.className = 'table table-bordered table-sm';

                    const thead = tableEl.createTHead();
                    thead.className = 'table-light';
                    const headerRow = thead.insertRow();
                    const columns = Object.keys(records[0]);
                    columns.forEach(colName => {
                        const th = document.createElement('th');
                        th.textContent = colName;
                        headerRow.appendChild(th);
                    });

                    const tbody = tableEl.createTBody();
                    records.forEach(record => {
                        const row = tbody.insertRow();
                        columns.forEach(colName => {
                            const cell = row.insertCell();
                            cell.textContent = record[colName];
                        });
                    });

                    tableResponsive.appendChild(tableEl);
                    cardBody.appendChild(tableResponsive);
                    card.appendChild(cardBody);
                    sampleArea.appendChild(card);
                }
            } catch (error) {
                sampleArea.innerHTML = `<div class="alert alert-danger">ìƒ˜í”Œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
            } finally {
                sampleBtn.disabled = false;
                sampleBtn.textContent = 'ìƒ˜í”Œ ë³´ê¸°';
            }
        });
        
        modelInfoArea.addEventListener('click', (event) => {
            if (event.target.classList.contains('options-btn')) {
                const { tableName, columnName } = event.target.dataset;
                openOptionsModal(tableName, columnName);
            }
        });

        document.getElementById('save-options-btn').addEventListener('click', () => {
            const { tableName, columnName } = document.getElementById('save-options-btn').dataset;
            if (!generationOptions[tableName]) {
                generationOptions[tableName] = {};
            }
            const options = {};
            const minEl = document.getElementById('option-min');
            if (minEl && minEl.value) options.min = parseFloat(minEl.value);
            const maxEl = document.getElementById('option-max');
            if (maxEl && maxEl.value) options.max = parseFloat(maxEl.value);
            const typeEl = document.getElementById('option-type');
            if (typeEl && typeEl.value) options.type = typeEl.value;
            const listEl = document.getElementById('option-list');
            if (listEl && listEl.value) options.list = listEl.value.split(',').map(s => s.trim()).filter(Boolean);
            const startDateEl = document.getElementById('option-start-date');
            if (startDateEl && startDateEl.value) options.startDate = startDateEl.value;
            const endDateEl = document.getElementById('option-end-date');
            if (endDateEl && endDateEl.value) options.endDate = endDateEl.value;

            generationOptions[tableName][columnName] = options;
            optionsModal.hide();
        });

    </script>
</body>
</html>