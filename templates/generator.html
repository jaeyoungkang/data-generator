<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>데이터 생성기</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .table-responsive { max-height: 300px; }
        #log-container { display: none; max-height: 400px; overflow-y: auto; font-family: monospace; background-color:#212529; color: #f8f9fa; }
        #generator-controls { display: none; } /* [신규] 컨트롤 영역은 모델 선택 후 표시 */
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
             <h1 class="h3">데이터 생성기</h1>
             <a href="/" class="btn btn-sm btn-outline-secondary">시작 페이지로</a>
        </div>
       
        <div class="mb-4">
            <label for="model-select" class="form-label"><strong>1. 생성할 데이터 모델 선택</strong></label>
            <select class="form-select" id="model-select">
                <option selected disabled>저장된 모델을 선택하세요...</option>
                {% for filename in model_files %}
                <option value="{{ filename }}">{{ filename }}</option>
                {% endfor %}
            </select>
        </div>

        <div id="generator-controls">
            <div class="card mb-4">
                <div class="card-header">
                    2. 데이터 생성 수량 입력
                </div>
                <div class="card-body">
                    <div class="row g-3" id="quantity-form">
                        </div>
                </div>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-4">
                <button class="btn btn-info" id="sample-btn">샘플 보기</button>
                <button class="btn btn-success" id="generate-btn">전체 데이터 생성</button>
            </div>

            <div id="sample-area">
                </div>
        </div>
        
        <div class="form-control mt-3" id="log-container"></div>
    </div>

    <script>
        const modelSelect = document.getElementById('model-select');
        const controls = document.getElementById('generator-controls');
        const quantityForm = document.getElementById('quantity-form');
        const sampleArea = document.getElementById('sample-area');
        const sampleBtn = document.getElementById('sample-btn');
        const generateBtn = document.getElementById('generate-btn');

        // [수정] 모델 선택 이벤트 리스너
        modelSelect.addEventListener('change', async (event) => {
            const filename = event.target.value;
            if (!filename) return;

            // API를 통해 선택된 모델의 상세 정보 가져오기
            const response = await fetch(`/get-model/${filename}`);
            const model = await response.json();

            // 기존 내용 초기화
            quantityForm.innerHTML = '';
            sampleArea.innerHTML = '';

            // 수량 입력 필드 및 샘플 영역 동적 생성
            for (const table in model) {
                // 수량 입력 필드
                const qtyCol = document.createElement('div');
                qtyCol.className = 'col-md-4';
                qtyCol.innerHTML = `
                    <label for="qty-${table}" class="form-label"><strong>${table}</strong></label>
                    <input type="number" class="form-control" id="qty-${table}" value="100" data-table-name="${table}">
                `;
                quantityForm.appendChild(qtyCol);

                // 샘플 테이블 영역
                const sampleCard = document.createElement('div');
                sampleCard.className = 'card mb-3';
                sampleCard.id = `card-${table}`;
                sampleCard.style.display = 'none';
                sampleCard.innerHTML = `
                    <div class="card-header">${table} 샘플 데이터</div>
                    <div class="card-body">
                        <div class="table-responsive" id="sample-${table}"></div>
                    </div>
                `;
                sampleArea.appendChild(sampleCard);
            }
            
            // 컨트롤 영역 표시
            controls.style.display = 'block';
        });

        function getQuantities() {
            const quantities = {};
            quantityForm.querySelectorAll('input[type="number"]').forEach(input => {
                quantities[input.dataset.tableName] = input.value;
            });
            return quantities;
        }

        sampleBtn.addEventListener('click', async () => {
            const selectedModel = modelSelect.value;
            if (!selectedModel) {
                alert('모델을 먼저 선택해주세요.');
                return;
            }
            sampleBtn.disabled = true;
            sampleBtn.textContent = '샘플 생성 중...';

            const quantities = getQuantities();
            
            const response = await fetch('/generate-sample', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: selectedModel, quantities: quantities })
            });
            const sampleData = await response.json();

            for (const table in sampleData) {
                const card = document.getElementById(`card-${table}`);
                const sampleDiv = document.getElementById(`sample-${table}`);
                if(sampleDiv && card) {
                    sampleDiv.innerHTML = sampleData[table];
                    card.style.display = 'block';
                }
            }
            
            sampleBtn.disabled = false;
            sampleBtn.textContent = '샘플 보기';
        });

        generateBtn.addEventListener('click', () => {
            const selectedModel = modelSelect.value;
            if (!selectedModel) {
                alert('모델을 먼저 선택해주세요.');
                return;
            }
            generateBtn.disabled = true;
            const logContainer = document.getElementById('log-container');
            logContainer.style.display = 'block';
            logContainer.innerHTML = '✅ 데이터 생성 스트림 시작...\n';

            const quantities = getQuantities();
            quantities.filename = selectedModel; // 쿼리에 파일명 추가
            const queryParams = new URLSearchParams(quantities).toString();

            const eventSource = new EventSource(`/start-generation?${queryParams}`);
            eventSource.onmessage = function (event) {
                const logEntry = JSON.parse(event.data);
                logContainer.innerHTML += `${logEntry.message.replace(/</g, "&lt;").replace(/>/g, "&gt;")}\n`;
                logContainer.scrollTop = logContainer.scrollHeight;

                if (logEntry.type === 'complete') {
                    eventSource.close();
                    generateBtn.textContent = '생성 완료!';
                }
            };
        });
    </script>
</body>
</html>