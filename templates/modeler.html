<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini API ë°ì´í„° ìƒì„±ê¸°</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* --- [ìˆ˜ì •] ê°€ë…ì„± ê°œì„ ì„ ìœ„í•œ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ ë³€ê²½ --- */
        :root {
            --background-color: #131314;
            --surface-color: #1e1f20;
            --text-color: #e3e3e3;
            --secondary-text-color: #c4c7c5;
            /* [ìˆ˜ì •] ì‚¬ìš©ì ë²„ë¸” ìƒ‰ìƒì„ ë” ë°ê²Œ ë³€ê²½ */
            --user-bubble-color: #2E4C6D; 
            /* [ìˆ˜ì •] LLM ë²„ë¸” ìƒ‰ìƒì„ ë°°ê²½ê³¼ ëª…í™•íˆ êµ¬ë¶„ë˜ë„ë¡ ë³€ê²½ */
            --llm-bubble-color: #3C4043;
            --input-bar-color: #1f1f1f;
            --border-color: #5f6368; /* [ìˆ˜ì •] ê²½ê³„ì„  ìƒ‰ìƒë„ ì•½ê°„ ë°ê²Œ */
        }

        * { box-sizing: border-box; }
        body {
            background-color: var(--background-color); color: var(--text-color);
            font-family: 'Roboto', 'Noto Sans KR', sans-serif; margin: 0;
            display: flex; flex-direction: column; height: 100vh;
        }
        .container {
            max-width: 840px; margin: 0 auto; flex-grow: 1; display: flex;
            flex-direction: column; padding: 1rem; width: 100%;
        }
        #chat-window { flex-grow: 1; overflow-y: auto; padding-right: 10px; }
        #chat-window::-webkit-scrollbar { width: 8px; }
        #chat-window::-webkit-scrollbar-track { background: transparent; }
        #chat-window::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        
        .message { margin-bottom: 2rem; display: flex; align-items: flex-start; gap: 1rem; }
        
        .avatar {
            width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0;
            /* [ìˆ˜ì •] ì•„ë°”íƒ€ ë°°ê²½ìƒ‰ë„ ë²„ë¸” ìƒ‰ìƒê³¼ ë™ê¸°í™” */
            background-color: var(--llm-bubble-color);
        }

        .user-message .avatar {
            background-color: var(--user-bubble-color);
        }

        .bubble {
            padding: 0.75rem 1.1rem; /* [ìˆ˜ì •] íŒ¨ë”© ì¶”ê°€ë¡œ í…ìŠ¤íŠ¸ì™€ ê²½ê³„ ì‚¬ì´ì— ì—¬ë°± í™•ë³´ */
            max-width: calc(100% - 48px);
            border-radius: 12px;
            /* [ìˆ˜ì •] ë²„ë¸” ë°°ê²½ìƒ‰ ì§€ì • */
            background-color: var(--llm-bubble-color);
        }
        .user-message .bubble {
            background-color: var(--user-bubble-color);
        }

        .bubble p { margin: 0 0 0.5em 0; line-height: 1.6; }
        .bubble p:last-child { margin-bottom: 0; }
        .bubble pre { background-color: #131212; padding: 1em; border-radius: 8px; white-space: pre-wrap; word-wrap: break-word; }
        .bubble code { font-family: 'SF Mono', 'Menlo', monospace; background-color: #333; padding: 0.2em 0.4em; border-radius: 4px; }
        .bubble pre code { background-color: transparent; padding: 0; }
        
        #chat-form-wrapper { padding: 1rem 0; }
        #chat-form {
            display: flex; align-items: center; background-color: var(--input-bar-color);
            border: 1px solid var(--border-color); border-radius: 24px; padding: 0.5rem 1rem;
        }
        #message-input {
            flex-grow: 1; border: none; background: transparent; color: var(--text-color);
            font-size: 1rem; padding: 0.5rem;
        }
        #message-input:focus { outline: none; }
        #submit-button {
            background: none; border: none; color: var(--secondary-text-color);
            font-size: 1.5rem; cursor: pointer; padding: 0.5rem;
        }
        #submit-button:disabled { opacity: 0.5; cursor: not-allowed; }
        #log-container {
            font-family: monospace; background-color: var(--surface-color); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 1rem; max-height: 300px; overflow-y: auto;
            margin-top: 1rem; display: none;
        }
        #api-status {
            font-size: 0.85rem; padding: 0.3rem 0.6rem;
            border-radius: 0.25rem; font-weight: 500;
        }
        .status-ok { background-color: #d1e7dd; color: #0f5132; }
        .status-error { background-color: #f8d7da; color: #842029; }
    </style>
</head>
<body>
    <div class="container py-3">
        <div class="text-center mb-3">
            <h1 class="h4">AI ì–´ì‹œìŠ¤í„´íŠ¸ì™€ ë°ì´í„° ìƒì„±í•˜ê¸°</h1>
            <div id="api-status" class="d-inline-block">API ìƒíƒœ í™•ì¸ ì¤‘...</div>
        </div>
        <div id="chat-window"></div>
        <div id="chat-form-wrapper">
            <form id="chat-form">
                <input type="text" id="message-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off" required>
                <button type="submit" id="submit-button" aria-label="ì „ì†¡">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M2 21l21-9L2 3v7l15 2-15 2z"/></svg>
                </button>
            </form>
        </div>
        <div id="log-container"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const chatWindow = document.getElementById('chat-window');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const submitButton = document.getElementById('submit-button');
        const logContainer = document.getElementById('log-container');
        const apiStatus = document.getElementById('api-status');

        function addMessage(text, sender) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', `${sender}-message`);
            const avatarIcon = sender === 'user' ? 'ğŸ‘¤' : 'âœ¨';
            
            // [ìˆ˜ì •] ë²„ë¸”ê³¼ ì•„ë°”íƒ€ êµ¬ì¡°ë¥¼ ë‹¨ìˆœí™”í•˜ì—¬ CSSë¡œ ì œì–´
            messageElement.innerHTML = `
                <div class="avatar">${avatarIcon}</div>
                <div class="bubble"></div>
            `;
            const bubble = messageElement.querySelector('.bubble');
            bubble.innerHTML = marked.parse(text);
            chatWindow.appendChild(messageElement);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return messageElement;
        }

        // JavaScriptì˜ ë‚˜ë¨¸ì§€ ë¶€ë¶„ì€ ì´ì „ ë‹µë³€ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ë©ë‹ˆë‹¤.
        // ... (ì´í•˜ ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œëŠ” ë³€ê²½ ì—†ìŒ) ...
        function handleStream(userMessage) {
            messageInput.disabled = true;
            submitButton.disabled = true;

            let llmMessageElement = null;
            let fullResponseText = ""; 

            fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: userMessage })
            }).then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                function push() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            if (llmMessageElement) {
                                llmMessageElement.querySelector('.bubble').innerHTML = marked.parse(fullResponseText);
                            }
                            messageInput.disabled = false;
                            submitButton.disabled = false;
                            messageInput.focus();
                            return;
                        }

                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n\n');

                        for (const line of lines) {
                            if (line.startsWith('data:')) {
                                try {
                                    const data = JSON.parse(line.substring(5));
                                    
                                    if (!llmMessageElement) {
                                        llmMessageElement = addMessage('', 'llm');
                                    }

                                    if (data.type === 'token') {
                                        fullResponseText += data.content;
                                        llmMessageElement.querySelector('.bubble').textContent = fullResponseText;
                                    } else if (data.type === 'full_message' || data.type === 'next_step') {
                                        fullResponseText = data.content;
                                        llmMessageElement.querySelector('.bubble').innerHTML = marked.parse(fullResponseText);
                                        if (data.action === 'start_generation') {
                                            startGenerationStream();
                                        }
                                    }
                                } catch (e) {
                                    console.error("JSON Parse Error:", e);
                                }
                            }
                        }
                        chatWindow.scrollTop = chatWindow.scrollHeight;
                        push();
                    });
                }
                push();
            });
        }

        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const userMessage = messageInput.value.trim();
            if (!userMessage) return;
            addMessage(userMessage, 'user');
            messageInput.value = '';
            handleStream(userMessage);
        });

        window.addEventListener('load', async () => {
            messageInput.disabled = true;
            submitButton.disabled = true;

            try {
                const statusResponse = await fetch('/api-status');
                const statusData = await statusResponse.json();

                if (statusData.status === 'ok') {
                    apiStatus.textContent = `ğŸŸ¢ ${statusData.message}`;
                    apiStatus.className = 'd-inline-block status-ok';
                    handleStream('');
                } else {
                    apiStatus.textContent = `ğŸ”´ ${statusData.message}`;
                    apiStatus.className = 'd-inline-block status-error';
                    addMessage(`[ì‹œìŠ¤í…œ ì˜¤ë¥˜] ${statusData.message}\n\n.env íŒŒì¼ì˜ API í‚¤ë¥¼ í™•ì¸í•˜ê³  í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.`, 'llm');
                }
            } catch (e) {
                const errorMsg = 'ë°±ì—”ë“œ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.';
                apiStatus.textContent = `ğŸ”´ ${errorMsg}`;
                apiStatus.className = 'd-inline-block status-error';
                addMessage(`[ì‹œìŠ¤í…œ ì˜¤ë¥˜] ${errorMsg}`, 'llm');
            }
        });

        function startGenerationStream() {
            logContainer.style.display = 'block';
            logContainer.innerHTML = 'âœ… ë°ì´í„° ìƒì„± ìŠ¤íŠ¸ë¦¼ ì‹œì‘...\n';
            const eventSource = new EventSource('/start-generation');
            eventSource.onmessage = function (event) {
                const logEntry = JSON.parse(event.data);
                logContainer.innerHTML += `${logEntry.message}\n`;
                logContainer.scrollTop = logContainer.scrollHeight;
                if (logEntry.type === 'complete') {
                    eventSource.close();
                    addMessage("ë°ì´í„° ìƒì„±ì´ ëª¨ë‘ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë„ì›€ì´ ë” í•„ìš”í•˜ì‹œë©´ ì–¸ì œë“ ì§€ ë§ì”€í•´ì£¼ì„¸ìš”.", 'llm');
                    messageInput.disabled = false;
                    submitButton.disabled = false;
                    messageInput.focus();
                }
            };
        }
    </script>
</body>
</html>